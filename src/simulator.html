<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Driving Simulator</title>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            user-select: none;
        }

        h2 { margin-top: 0; color: #aaa; text-transform: uppercase; letter-spacing: 2px;}

        /* DASHBOARD DISPLAY */
        .dash-display {
            background: black;
            border: 4px solid #444;
            border-radius: 10px;
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .dash-metric { text-align: center; }
        .dash-val { font-size: 3rem; font-weight: bold; font-family: monospace; color: #00e676; }
        .dash-label { color: #666; font-size: 0.8rem; }
        .gear-val { color: white; font-size: 4rem; }

        /* CONTROLS */
        .controls-area {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        /* GEARBOX */
        .gearbox {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #333;
            padding: 15px;
            border-radius: 8px;
        }
        .gear-btn {
            width: 60px;
            height: 60px;
            background: #444;
            border: none;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px 0 #111;
        }
        .gear-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-start { background: #d32f2f; height: 50px; font-size: 0.9rem; margin-top: 20px; }
        .btn-start.on { background: #00e676; color: black; box-shadow: 0 0 15px #00e676; }

        /* PEDALS */
        .pedal-group {
            display: flex;
            gap: 20px;
        }
        .pedal-container {
            width: 60px;
            height: 250px;
            background: #111;
            border-radius: 5px;
            position: relative;
            border: 1px solid #555;
        }
        .pedal-slider {
            -webkit-appearance: none;
            width: 250px;
            height: 60px;
            background: transparent;
            position: absolute;
            top: 95px; left: -95px; /* Rotate logic */
            transform: rotate(-90deg);
            cursor: pointer;
            z-index: 2;
        }
        .pedal-visual {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: #444;
            transition: height 0.05s;
            border-radius: 4px;
        }
        .pedal-label { text-align: center; margin-top: 10px; font-weight: bold;}
        
        .pedal-container.accel .pedal-visual { background: linear-gradient(to top, #ff9100, #ffea00); }
        .pedal-container.brake .pedal-visual { background: linear-gradient(to top, #b71c1c, #f44336); }

    </style>
</head>
<body>

    <h2>Simulatore Banco Prova</h2>

    <div class="dash-display">
        <div class="dash-metric">
            <div class="dash-val" id="rpm">0</div>
            <div class="dash-label">RPM</div>
        </div>
        <div class="dash-metric">
            <div class="dash-val gear-val" id="gear">N</div>
            <div class="dash-label">MARCIA</div>
        </div>
        <div class="dash-metric">
            <div class="dash-val" id="speed">0</div>
            <div class="dash-label">KM/H</div>
        </div>
    </div>

    <div class="controls-area">
        <div class="gearbox">
            <button class="gear-btn" onclick="shift(1)">+</button>
            <button class="gear-btn" onclick="shift(-1)">-</button>
            <button class="gear-btn btn-start" id="ign-btn" onclick="toggleIgnition()">START</button>
        </div>

        <div class="pedal-group">
            <div>
                <div class="pedal-container brake">
                    <div class="pedal-visual" id="vis-brk" style="height: 0%"></div>
                    <input type="range" min="0" max="1" step="0.01" value="0" class="pedal-slider" 
                           oninput="updatePedals()" onchange="releasePedal(this)" id="in-brk">
                </div>
                <div class="pedal-label">FRENO</div>
            </div>
            <div>
                <div class="pedal-container accel">
                    <div class="pedal-visual" id="vis-thr" style="height: 0%"></div>
                    <input type="range" min="0" max="1" step="0.01" value="0" class="pedal-slider" 
                           oninput="updatePedals()" onchange="releasePedal(this)" id="in-thr">
                </div>
                <div class="pedal-label">GAS</div>
            </div>
        </div>
    </div>

    <script>
        // --- PREVENZIONE ERRORI IN ANTEPRIMA ---
        // Se pywebview non esiste (perché siamo nel browser/preview), creiamo un Mock.
        if (typeof pywebview === 'undefined') {
            console.log("⚠️ pywebview non trovato. Attivazione modalità Mock per anteprima.");
            window.pywebview = {
                api: {
                    // Stato locale fittizio per l'anteprima
                    _state: { rpm: 0, speed: 0, gear: 0, engine_on: false },
                    
                    get_sim_state: async function() {
                        // Semplice fisica fake per vedere qualcosa muoversi nel preview
                        if(this._state.engine_on) {
                            if(this._state.rpm < 800) this._state.rpm = 800;
                        } else {
                            if(this._state.rpm > 0) this._state.rpm -= 50;
                        }
                        return this._state;
                    },
                    sim_control: async function(th, br, sh, ign) {
                        // Aggiorna lo stato fittizio
                        if (ign !== null && ign !== undefined) this._state.engine_on = ign;
                        if (sh) {
                            this._state.gear += sh;
                            if(this._state.gear < 0) this._state.gear = 0;
                        }
                        // Fake revving
                        if (parseFloat(th) > 0 && this._state.engine_on) {
                            this._state.rpm += parseFloat(th) * 200;
                            if(this._state.rpm > 7000) this._state.rpm = 7000;
                        } else if (this._state.engine_on) {
                             if(this._state.rpm > 850) this._state.rpm -= 100;
                        }
                    }
                }
            };
        }

        let engineOn = false;

        // Loop di aggiornamento VISIVO
        setInterval(async () => {
            // Ora pywebview esiste sempre grazie al fix sopra
            try {
                const data = await pywebview.api.get_sim_state();
                
                document.getElementById('rpm').innerText = Math.floor(data.rpm);
                document.getElementById('speed').innerText = Math.floor(data.speed);
                document.getElementById('gear').innerText = data.gear === 0 ? 'N' : data.gear;
                
                engineOn = data.engine_on;
                const btn = document.getElementById('ign-btn');
                if(engineOn) {
                    btn.classList.add('on');
                    btn.innerText = "STOP";
                } else {
                    btn.classList.remove('on');
                    btn.innerText = "START";
                }
            } catch (e) {
                console.error("Errore API:", e);
            }
        }, 50);

        function updatePedals() {
            const thr = document.getElementById('in-thr').value;
            const brk = document.getElementById('in-brk').value;
            
            document.getElementById('vis-thr').style.height = (thr * 100) + '%';
            document.getElementById('vis-brk').style.height = (brk * 100) + '%';

            // Invia i comandi
            if (window.pywebview) {
                pywebview.api.sim_control(thr, brk, 0, null);
            }
        }

        function releasePedal(el) {
            el.value = 0;
            updatePedals();
        }

        function shift(dir) {
            if (window.pywebview) {
                pywebview.api.sim_control(0, 0, dir, null);
            }
        }

        function toggleIgnition() {
            if (window.pywebview) {
                pywebview.api.sim_control(0, 0, 0, !engineOn);
            }
        }
    </script>
</body>
</html>