<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>ECU Tuner Suite</title>
    <style>
        :root { --bg: #0a0a0a; --panel: #141414; --accent: #00ff88; --danger: #ff1744; --text: #eee; --border: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; }
        
        #landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .mode-container { display: flex; gap: 40px; margin-top: 50px; }
        .mode-card { background: #111; border: 1px solid #333; padding: 40px; border-radius: 12px; width: 250px; text-align: center; cursor: pointer; transition: 0.3s; }
        .mode-card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 0 20px rgba(0, 255, 136, 0.2); }
        .mode-icon { font-size: 4rem; margin-bottom: 20px; }
        
        #main-app { display: none; height: 100%; width: 100%; display: flex; }
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .brand { color: var(--accent); font-size: 1.4rem; font-weight: bold; margin-bottom: 40px; }
        .nav-item { padding: 15px; cursor: pointer; color: #888; transition: 0.2s; border-radius: 6px; margin-bottom: 5px; }
        .nav-item:hover { background: #222; color: #fff; }
        .nav-item.active { background: #1f2f25; color: var(--accent); border: 1px solid #1f4f35; }
        
        .main-area { flex: 1; display: flex; flex-direction: column; background: radial-gradient(circle at top right, #111, #000); overflow: hidden; }
        .header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;}
        .content { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .content.active { display: block; }

        .ecu-info { background: #111; padding: 15px 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #333; font-size: 0.9rem; color: #aaa; display: flex; gap: 30px; align-items: center; }
        .grid-diag { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .card { background: #111; border: 1px solid var(--border); padding: 20px; border-radius: 8px; }
        .card-val { font-size: 2.5rem; font-weight: bold; margin: 10px 0; font-family: monospace; }
        
        .tuning-controls { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px;}
        .btn { padding: 10px 20px; border: 1px solid var(--border); background: #222; color: white; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .btn:hover { border-color: var(--accent); }
        .btn.primary { background: var(--accent); color: black; border: none; font-weight: bold; }
        .btn:disabled { opacity: 0.5; cursor: wait; }

        .sub-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .sub-tab-item { padding: 10px 20px; cursor: pointer; color: #888; border-bottom: 2px solid transparent; }
        .sub-tab-item:hover { color: white; }
        .sub-tab-item.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }

        .hex-grid { display: grid; grid-template-columns: 80px repeat(16, 1fr); gap: 2px; font-family: monospace; font-size: 0.9rem; margin-top: 20px; user-select: none; }
        .hex-cell { padding: 5px; text-align: center; background: #0f0f0f; border: 1px solid #222; cursor: pointer; transition: 0.1s; }
        .hex-cell:hover { border-color: var(--accent); background: #1a1a1a; }
        .hex-offset { color: var(--accent); text-align: right; padding-right: 10px; opacity: 0.7; }
        .hex-header { color: #666; text-align: center; padding-bottom: 5px; }

        .stage-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .stage-card { background: #1a1a1a; border: 1px solid var(--border); padding: 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;}
        .stage-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .stage-badge { position: absolute; top: 10px; right: 10px; background: #333; padding: 2px 8px; font-size: 0.7rem; border-radius: 4px; }
        
        /* LIBRARY TABLE */
        .lib-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .lib-table th { text-align: left; padding: 10px; border-bottom: 1px solid #333; color: #888; }
        .lib-table td { padding: 10px; border-bottom: 1px solid #222; }
        .lib-table tr:hover { background: #111; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .tag.ori { background: #2196f3; color: white; }
        .tag.mod { background: #e91e63; color: white; }

        .status-bar { height: 4px; background: #222; width: 100%; position: absolute; top: 0; left: 0; }
        .status-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.2s; }
        .console { background: black; padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: #888; border-top: 1px solid var(--border); }
    </style>
</head>
<body>
    <script>if(typeof pywebview==='undefined')window.pywebview={api:{set_mode:async()=>{},get_data:async()=>({rpm:800}),get_status:async()=>({file_loaded:true,filename:"demo.bin",progress:0,logs:[]}),get_hex_view:async()=>[],apply_wizard_stage:async()=>({status:'success'}),get_ecu_info:async()=>({name:"Demo"}),get_library_maps:async()=>[]}};</script>

    <div id="landing-page">
        <h1 style="font-size:3rem; margin-bottom:10px;">ECU TUNER <span style="color:var(--accent)">SUITE</span></h1>
        <div style="color:#666">Seleziona ambiente di lavoro</div>
        <div class="mode-container">
            <div class="mode-card" onclick="selectMode('sim')"><div class="mode-icon">ðŸŽ®</div><div style="font-size:1.5rem;font-weight:bold">Simulatore</div></div>
            <div class="mode-card" onclick="selectMode('real')"><div class="mode-icon">ðŸ”Œ</div><div style="font-size:1.5rem;font-weight:bold">Reale (OBD)</div></div>
        </div>
    </div>

    <div id="main-app">
        <div class="sidebar">
            <div class="brand">âš¡ ECU SUITE</div>
            <div class="nav-item active" id="nav-diag" onclick="nav('diag')">Diagnostica</div>
            <div class="nav-item" id="nav-tune" onclick="nav('tune')">Tuning & Mappe</div>
            <div class="nav-item" id="nav-lib" onclick="nav('lib')">Archivio Mappe</div>
            <div class="nav-item" id="btn-open-sim" onclick="api('open_sim')">Apri Simulatore</div>
            <div class="nav-item" onclick="location.reload()" style="margin-top:auto; color:#d32f2f">ðŸ”™ Esci</div>
        </div>

        <div class="main-area">
            <div class="status-bar"><div class="status-fill" id="p-bar"></div></div>
            <div class="header">
                <h2 id="page-title">Diagnostica Motore</h2>
                <div id="conn-status" style="color:#666">DISCONNESSO</div>
            </div>

            <!-- DIAGNOSTICA -->
            <div id="page-diag" class="content active">
                <div class="grid-diag">
                    <div class="card"><div style="color:#666; font-size:0.8rem">GIRI MOTORE</div><div class="card-val" style="color:white"><span id="d-rpm">0</span> rpm</div></div>
                    <div class="card"><div style="color:#666; font-size:0.8rem">VELOCITÃ€</div><div class="card-val" style="color:var(--accent)"><span id="d-spd">0</span> km/h</div></div>
                    <div class="card"><div style="color:#666; font-size:0.8rem">TEMP. ACQUA</div><div class="card-val" id="d-temp-c" style="color:#4fc3f7">--Â°C</div></div>
                    <div class="card"><div style="color:#666; font-size:0.8rem">BATTERIA</div><div class="card-val" id="d-volt-c" style="color:#ffb74d">--V</div></div>
                    <div class="card"><div style="color:#666; font-size:0.8rem">POS. ACCELERATORE</div><div class="card-val"><span id="d-thr">0</span>%</div></div>
                </div>
            </div>

            <!-- ARCHIVIO MAPPE -->
            <div id="page-lib" class="content">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3>Libreria File Locali</h3>
                    <button class="btn" onclick="refreshLib()">ðŸ”„ Aggiorna</button>
                </div>
                <table class="lib-table">
                    <thead><tr><th>Nome File</th><th>Veicolo</th><th>ECU HW</th><th>Tipo</th><th>Azioni</th></tr></thead>
                    <tbody id="lib-container"></tbody>
                </table>
            </div>

            <!-- TUNING -->
            <div id="page-tune" class="content">
                <div class="ecu-info"><span>Connetti un veicolo per vedere i dati ID Centralina.</span></div>
                
                <div class="tuning-controls">
                    <button id="btn-read" class="btn" onclick="readECU()">â¬‡ LEGGI ECU</button>
                    <button id="btn-save" class="btn" onclick="saveMod()">ðŸ’¾ SALVA MOD</button>
                    <button id="btn-write" class="btn primary" onclick="writeECU()">â¬† SCRIVI ECU</button>
                    <div style="margin-left:auto; color:#666" id="file-lbl">Nessun file</div>
                </div>

                <div class="sub-tabs">
                    <div class="sub-tab-item active" id="st-wiz" onclick="subTab('wiz')">Wizard (Stages)</div>
                    <div class="sub-tab-item" id="st-hex" onclick="subTab('hex')">Editor Esadecimale</div>
                </div>

                <div id="sub-wiz">
                    <div class="stage-list">
                        <div class="stage-card" onclick="applyStage('stage1')"><div class="stage-badge">SAFE</div><h3>ðŸš€ Stage 1</h3><p style="color:#888;font-size:0.9rem">Ottimizzazione base. +25CV, +40Nm.</p></div>
                        <div class="stage-card" onclick="applyStage('popbang')"><div class="stage-badge">NOISY</div><h3>ðŸ’¥ Pop & Bang</h3><p style="color:#888;font-size:0.9rem">Scoppiettio in rilascio.</p></div>
                        <div class="stage-card" onclick="applyStage('egroff')"><div class="stage-badge">OFFROAD</div><h3>ðŸš« EGR Delete</h3><p style="color:#888;font-size:0.9rem">Chiusura valvola EGR.</p></div>
                        <div class="stage-card" onclick="applyStage('restore')" style="border-color:#d32f2f"><h3>Oem Originale</h3><p style="color:#888;font-size:0.9rem">Ripristino di fabbrica.</p></div>
                    </div>
                </div>

                <div id="sub-hex" style="display:none">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <button class="btn" onclick="hexPage(-256)">Indietro</button>
                        <span id="hex-addr" style="font-family:monospace; color:var(--accent)">0x0000</span>
                        <button class="btn" onclick="hexPage(256)">Avanti</button>
                    </div>
                    <div class="hex-grid" id="hex-container"></div>
                </div>
            </div>

            <div class="console" id="log-box">Log sistema pronto...</div>
        </div>
    </div>

    <script>
        let currentHexOffset = 0;
        let updateTimer = null;

        async function api(name, ...args) { if(window.pywebview.api[name]) return await window.pywebview.api[name](...args); }

        async function selectMode(mode) {
            await api('set_mode', mode);
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            if(mode === 'sim') {
                document.getElementById('conn-status').innerText = "CONNESSO (SIM)";
                document.getElementById('conn-status').style.color = "var(--accent)";
                document.getElementById('btn-open-sim').style.display = 'block';
                updateTimer = setInterval(updateAll, 100);
            } else {
                document.getElementById('btn-open-sim').style.display = 'none';
            }
        }

        async function updateAll() {
            if(document.getElementById('page-diag').style.display !== 'none') {
                const d = await api('get_data');
                document.getElementById('d-rpm').innerText = d.rpm;
                document.getElementById('d-spd').innerText = d.speed;
                document.getElementById('d-temp-c').innerText = d.temp + "Â°C";
                document.getElementById('d-volt-c').innerText = d.volt + "V";
                document.getElementById('d-thr').innerText = d.throttle;
                document.getElementById('d-volt-c').style.color = d.volt < 12.0 ? '#ff5252' : '#ffb74d';
            }
            const s = await api('get_flash_status');
            document.getElementById('p-bar').style.width = s.progress + "%";
            if(s.file_loaded) document.getElementById('file-lbl').innerText = "FILE: " + s.filename;
            if(s.logs.length > 0) {
                const logBox = document.getElementById('log-box');
                logBox.innerHTML = s.logs.join('<br>') + '<br>_';
                logBox.scrollTop = logBox.scrollHeight;
            }
            document.getElementById('btn-read').disabled = s.working;
            document.getElementById('btn-write').disabled = s.working;
            if(s.working) {
                document.getElementById('btn-read').innerText = "OPERAZIONE IN CORSO...";
                document.getElementById('btn-write').innerText = "ATTENDERE...";
            } else {
                document.getElementById('btn-read').innerText = "â¬‡ LEGGI ECU";
                document.getElementById('btn-write').innerText = "â¬† SCRIVI ECU";
            }
        }

        function nav(page) {
            document.querySelectorAll('.content').forEach(e => { e.classList.remove('active'); e.style.display = 'none'; });
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('page-'+page).classList.add('active');
            document.getElementById('page-'+page).style.display = 'block';
            document.getElementById('nav-'+page).classList.add('active');
            const titles = { 'diag': 'Diagnostica', 'tune': 'Suite di Rimappatura', 'lib': 'Archivio Mappe' };
            document.getElementById('page-title').innerText = titles[page];
            if(page === 'tune') { renderHex(); updateECUInfo(); }
            if(page === 'lib') refreshLib();
        }

        function subTab(tab) {
            document.getElementById('sub-wiz').style.display = tab === 'wiz' ? 'block' : 'none';
            document.getElementById('sub-hex').style.display = tab === 'hex' ? 'block' : 'none';
            document.getElementById('st-wiz').classList.toggle('active', tab === 'wiz');
            document.getElementById('st-hex').classList.toggle('active', tab === 'hex');
            if(tab === 'hex') renderHex();
        }

        async function updateECUInfo() {
            try {
                const info = await api('get_ecu_info');
                if(info) document.querySelector('.ecu-info').innerHTML = `<div>HW: <span style="color:white">${info.ecu_hw}</span></div><div>SW: <span style="color:white">${info.ecu_sw}</span></div><div>VEICOLO: <span style="color:var(--accent); font-weight:bold">${info.name}</span></div>`;
            } catch(e) {}
        }

        async function refreshLib() {
            const maps = await api('get_library_maps');
            const c = document.getElementById('lib-container');
            c.innerHTML = '';
            maps.forEach(m => {
                const typeClass = m.type === 'ORI' ? 'ori' : 'mod';
                c.innerHTML += `<tr><td>${m.filename}</td><td>${m.name}</td><td>${m.ecu}</td><td><span class="tag ${typeClass}">${m.type}</span></td><td><button class="btn" onclick="loadLibMap('${m.filename}')">Carica</button> <button class="btn danger" onclick="delMap('${m.filename}')">X</button></td></tr>`;
            });
        }

        async function loadLibMap(fname) {
            const r = await api('load_map_from_library', fname);
            if(r.status==='success') { alert(r.msg); nav('tune'); } else alert(r.msg);
        }
        async function delMap(fname) { if(confirm('Eliminare ' + fname + '?')) { await api('delete_library_map', fname); refreshLib(); } }
        async function saveMod() {
            const name = prompt("Inserisci nome per la MOD (es. Stage1):", "Mod1");
            if(name) { const r = await api('save_current_map', name); alert(r.msg); }
        }

        async function readECU() { await api('read_ecu'); }
        async function writeECU() { const r = await api('write_ecu'); if(r.status==='error') alert(r.msg); }
        async function applyStage(n) { const r = await api('apply_wizard_stage', n); if(r.status==='error') alert(r.msg); else { alert("Stage applicato!"); renderHex(); } }

        async function renderHex() {
            const data = await api('get_hex_view', currentHexOffset);
            const container = document.getElementById('hex-container');
            container.innerHTML = '<div></div>'; 
            for(let i=0; i<16; i++) container.innerHTML += `<div class="hex-header">${i.toString(16).toUpperCase()}</div>`;
            for(let i=0; i<data.length; i+=16) {
                const offset = currentHexOffset + i;
                container.innerHTML += `<div class="hex-offset">0x${offset.toString(16).padStart(4,'0').toUpperCase()}</div>`;
                for(let j=0; j<16; j++) {
                    if(i+j < data.length) {
                        const byteVal = data[i+j];
                        const byteStr = byteVal.toString(16).padStart(2,'0').toUpperCase();
                        const style = (byteStr === "FF" || byteStr === "00") ? "color:var(--accent)" : "color:#888"; 
                        container.innerHTML += `<div class="hex-cell" style="${style}" onclick="editByte(${offset+j}, '${byteStr}')">${byteStr}</div>`;
                    } else container.innerHTML += `<div></div>`;
                }
            }
            document.getElementById('hex-addr').innerText = `OFFSET: 0x${currentHexOffset.toString(16).toUpperCase()}`;
        }

        async function editByte(offset, currentVal) {
            const newVal = prompt(`Modifica Byte 0x${offset.toString(16).toUpperCase()}:`, currentVal);
            if(newVal !== null && /^[0-9A-Fa-f]{2}$/.test(newVal)) {
                await api('update_hex', offset, newVal);
                renderHex();
            }
        }

        function hexPage(delta) {
            const n = currentHexOffset + delta;
            if(n >= 0) { currentHexOffset = n; renderHex(); }
        }
    </script>
</body>
</html>